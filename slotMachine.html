<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
</head>
<body>
<script>
function setUname() {
    uname = document.getElementById("uname").value;
    window.location.href = "#"+uname;
    window.location.reload();
}
</script>
<div id="input" class="container-fluid" style="padding: 100px;">
    <div class="row">
        <div class="col-xs-8 col-xs-offset-2">
            <form class="form-inline" target="_self" onsubmit="javascript:setUname();return false;">
                <div class="form-group">
                    <label for="uname">uva username:</label>
                    <input type="text" class="form-control" id="uname" name="uname" placeholder="wolfdigit">
                </div>
                <button type="submit" class="btn btn-default">Go</button>
            </form>
        </div>
    </div>
</div>

<div id="main" style="display:none">
<div id="slot" style="height:50px; overflow-y:hidden; font-size:50px; line-height:50px; position:relative">
<div id="wheel1" style="position:absolute; left:0px">
0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br> <br>0<br>
</div>
<div id="wheel2" style="position:absolute; left:30px">
0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br> <br>0<br>
</div>
<div id="wheel3" style="position:absolute; left:60px">
0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br> <br>0<br>
</div>
<div id="wheel4" style="position:absolute; left:90px">
0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br> <br>0<br>
</div>
<div id="wheel5" style="position:absolute; left:120px">
0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br> <br>0<br>
</div>
</div>
</div>

<script>
var shifty = [0,0,0,0,0];
var slowId = -1;
var pnumDigit = [0,0,0,0,0];
function roll() {
	//console.log(slowId);
	font = 50;
	round = font * 11;
	speed = 15;
	if (slowId<5*2) setTimeout(roll, 30);
	for (i=0; i<5; i++) {
		if (i>Math.floor(slowId/2)) shiftAmt = speed;
		else if (i<Math.floor(slowId/2)) shiftAmt = 0;
		else {
			target = pnumDigit[i]*font;
			dist = (shifty[i]-target)%round;
			//console.log(slowId+", "+dist);
			if (slowId%2==0) {
				shiftAmt = speed;
				if (dist<speed) slowId++;
			}
			else {
				if (dist<speed) {
					shifty[i] = target;
					shiftAmt = 0;
					slowId++;
				}				
				else {
					shiftAmt = Math.pow((round-dist)/round, 0.4) * speed;
				}
			}
		}

		shifty[i] += shiftAmt;
		$("#wheel"+(i+1)).css("top", -(shifty[i]%round));
	}

	if (pnum!=null&&slowId==-1) {
		slowId = 0;
		tmp = pnum;
		for (i=4; i>=0; i--) {
			pnumDigit[i] = tmp % 10;
			tmp = Math.floor(tmp/10);
		}
		nonZero = 0;
		for (i=0; i<5; i++) {
			if (pnumDigit[i]!=0) nonZero = 1;
			if (!nonZero) {
				pnumDigit[i] = 10;
			}
		}
		console.log(pnumDigit);
	}
}

</script>
<script>
function main(uname) {
	$("#input").hide();
	$("#main").show();
	roll();
	getPid();
	getUid(uname);
	
	//bins = [];
	//for (i=0; i<60; i++) bins[i] = 0;
	//for (i=0; i<30000; i++) {
	//	baseRnd = normalRand();
	//	if (baseRnd>-3&&baseRnd<3) {
	//		bins[Math.floor((baseRnd+3)*10)]++;
	//	}
	//}
	//for (i=0; i<60; i++) $("<div>").css("width", bins[i]*1+"px").css("height", "10px").css("background-color", "red").appendTo("#main");
}

function getPid() {
	$.getJSON("http://uhunt.felix-halim.net/api/p", sortPid);
}

var probs;
var pids = [];
function sortPid(prbs) {
	probs = prbs;
	keys = Object.keys(probs);
	keys.sort(function(a,b){return (probs[a][3]>probs[b][3])?-1:1;});

	myPids = [];
	keys.forEach(function(val,key,arr){
		prob = probs[val];
		myPids.push(prob[0]);
	});
	pids = myPids;
}

function getUid(uname) {
	$.getJSON("http://uhunt.felix-halim.net/api/uname2uid/"+uname, getACs);
}

var acs = {};
function getACs(uid) {
	$.getJSON("http://uhunt.onlinejudge.org/api/solved-bits/"+uid, function(data) {
		//console.log(data);
		//$("<p>", {html: data}).appendTo("#main");
		data.forEach(function(val,key,arr) {
			if (val["uid"]==uid) {
				//console.log(val["solved"]);
				//console.log(Object.keys(acs).length);
				acs[uid] = val["solved"];
				//console.log(acs);
				//console.log(Object.keys(acs).length);
			}
		});
		
		produceData();
	});
}

var pnum=null;
function produceData() {
	if (pids.length==0) {
		setTimeout(produceData, 333);
	}
	else {
		//console.log(pids);
		uids = Object.keys(acs);
		ac = acs[uids[0]];
		//console.log(ac);
		
		//console.log(Object.keys(pids));
		acProbs = []; 
		//count = 0;
		pids.forEach(function(val,key) {
			rankAll = key+1;
			//rankAc = count+1;
			if (hasAc(val, ac)) {
				acProbs.push(rankAll);
				//count++;
			}
		});
		//console.log(acProbs);
		
		sumP = 0;
		sumW = 0;
		acProbs.forEach(function(val,key) {
			w = Math.exp((key+1)/acProbs.length*10);
			sumP += val*w;
			sumW += w;
		});
		mean = sumP / sumW;
		console.log("mean="+mean);
		
		// 1.5 sigma = (0.3~7.0) pages, each page = 150 probs
		// 1.5 sigma = 86%
		std = (Math.pow(mean/pids.length, 0.75)*6.7+0.3)*150/1.5;
		console.log("sigma="+std);
		
		ACed = 0;
		do {
			myRand = normalRand()*std+mean;
			console.log("myRand="+myRand);
			myRand = Math.floor(myRand);
			pid = pids[myRand];
			if (hasAc(pid,ac)) ACed = 1;
			else               ACed = 0;
		} while (ACed);
		
		console.log(probs[pid]);
		pnum = probs[pid][1];
		$("<p>", {html: "hardness: "+myRand+"/"+pids.length}).appendTo("#main");
		$("<p>", {html: "prob num: "+pnum}).appendTo("#main");
		$("<p>", {html: probs[pid][2]}).appendTo("#main");
	}
}

function hasAc(pid, acBits) {
	nByte = Math.floor(pid/32);
	nBit  = pid%32;
	
	return (acBits[nByte]&(1<<nBit))!=0;
}

function normalRand() {
         do {
                 x1 = 2.0 * Math.random() - 1.0;
                 x2 = 2.0 * Math.random() - 1.0;
                 w = x1 * x1 + x2 * x2;
         } while ( w >= 1.0 );

         w = Math.sqrt( (-2.0 * Math.log( w ) ) / w );
         y1 = x1 * w;
         y2 = x2 * w;
         
         return y1;
}

//main("wolfdigit");
uname = window.location.hash.substring(1);
if (uname.length>0) main(uname);
</script>
</body>
</html>

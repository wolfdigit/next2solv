<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Uva next2solv</title>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.9/d3.min.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" crossorigin="anonymous">
<!-- Latest compiled and minified JavaScript -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>
<style>
.inbl {
  display: inline-block;
  vertical-align:top;
  border: 1px solid black;
  font-size: calc(14px*2);
  width: calc(89px*2);
  height: calc(59px*2);
  overflow: hidden;
  background-color: rgba(230,230,230,1);
}
.inbl.ac {
  background-color: rgba(170,255,170,1);
}
.inbl.tried {
  background-color: rgba(170,170,255,1);
}
.inbl .pnum {
  display: block;
  font-size: calc(20px*2);
}
.inbl.popup {
  transition: transform 1s;
  transform: scale(2);
  font-size: calc(7px*2);
  overflow: auto;
}
.table-wrap {
  width: calc(90px*16*2);
  height: calc(60px*11*2);
  overflow: auto;
  padding: calc(30px*2) calc(45px*2) calc(30px*2) calc(45px*2);
  transform: scale(0.5);
  transform-origin: left top;
}
#contents {
  width: calc(90px*16);
  height: calc(60px*11);
  overflow: hidden;
}

.imgbl {
  fill: rgba(180,180,180,1);
}
.imgbl.ac {
  fill: rgba(0,255,0,1);
}
.imgbl.tried {
  fill: rgba(100,100,255,1);
}
</style>
<base target="_blank">
</head>
<body>

<div id="input" class="container-fluid" style="padding: 100px;">
    <div class="row">
        <div class="col-xs-8 col-xs-offset-2">
            <form class="form-inline" target="_self" onsubmit="javascript:setUname();return false;">
                <div class="form-group">
                    <label for="uname">uva username:</label>
                    <input type="text" class="form-control" id="uname" name="uname" placeholder="wolfdigit">
                </div>
                <button type="submit" class="btn btn-default">Go</button>
            </form>
        </div>
    </div>
</div>

<div id="slotMachine" style="display:none; margin:10px; width:100%; text-align:center">
	<!-- Button trigger modal -->
	<button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#myModal">
	  I'm feeling lucky!
	</button>

	<!-- Modal -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="myModalLabel">啊我就拉霸機咩~</h4>
		  </div>
		  <div class="modal-body">
			<div id="slotDiv"></div>
		  </div>
		  <!--
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			<button type="button" class="btn btn-primary">Save changes</button>
		  </div>
		  -->
		</div>
	  </div>
	</div>

	<form style="display: inline-block; margin-left: 30px; margin-bottom: -13px" onsubmit="return findPnumForm();">
		<div class="input-group">
			<input type="text" class="form-control" id="pnum" placeholder="problem number">
			<span class="input-group-btn">
				<button class="btn btn-secondary" id="findPnum" type="submit">Search</button>
			</span>
		</div>
	</form>
</div>

<ul class="nav nav-pills" id="tabs">
</ul>
<div class="tab-content" id="contents">
</div>


<script>
pgW = 15, pgH = 10;
imW = 3, imH = 3;

function setUname() {
    uname = document.getElementById("uname").value;
    window.location.href = "#"+uname;
    window.location.reload();
}
    
function mouseleave(d) {
    addClass = "";
    if (d["status"]=="ac") addClass = " ac";
    if (d["status"]=="tried") addClass = " tried";
	d3.select(this)
        .attr("class", "inbl"+addClass);
}

function mouseover(d) {
    addClass = "";
    if (d["status"]=="ac") addClass = " ac";
    if (d["status"]=="tried") addClass = " tried";
    d3.select(this)
        .attr("class", "inbl popup"+addClass);
}

var selectedPnum="";
function findPnum(pnum) {
	$("#p"+selectedPnum).css("background-color", "");
	$("#r"+selectedPnum).css("fill", "");

	selectedPnum = pnum;
	$('a[href="#tab' + pnum2tab[selectedPnum] + '"]').trigger('click');
    setTimeout(function(){
	  $("#p"+selectedPnum).css("background-color", "red");
	  $("#r"+selectedPnum).css("fill", "red");
	  $("#p"+selectedPnum).addClass("popup");	
	
	  $('#myModal').modal('hide');
    }, 500);
}

function findPnumForm() {
	findPnum($("#pnum").val());
	return false;
}

function showSlot() {
	$("#slotDiv iframe").remove();
	$("<iframe>", {src: "slotMachine.html#"+uname})
		.attr("frameborder", "0")
		.css("width", "100%")
		.css("height", "300px")
		.appendTo("#slotDiv");
	return false;
}

function p0(n) {
    if (n<10) return "0"+n;
    return ""+n;
}
    
  
function injectEvent() {
  $('.tab-pane').each(function(idx) {
    $(this).data("html", $(this).html());
    $(this).html("");
  });
  target = "#tab0";
  $(target).html($(target).data("html"));

  $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
    $('.tab-pane').each(function(idx) {
      html = $(this).html();
      if (html!="") $(this).data("html", html);
      $(this).html("");
    });
    var target = $(e.target).attr("href") // activated tab
    $(target).html($(target).data("html"));
  });
}
function render(theData) {
	d3.select("#input").remove();
	$("#myModal").on('shown.bs.modal', showSlot);
	$("#myModal").on('hidden.bs.modal', function() { $("#slotDiv iframe").remove(); });
	$("#slotMachine").show();
	var tab = d3.select("#tabs").selectAll("li")
		.data(theData).enter()
		.append("li")
		.attr("class", function(d,i){return (i==0)?"active":"";})
		.append("a")
		.attr("data-toggle", "tab")
		.attr("href", function(d,i){return "#tab"+i;});
	var svg = tab.append("svg")
		.attr("width", imW*pgW).attr("height", imH*pgH);
	svg.selectAll("rect")
		.data(function(d,i){return d;})
		.enter().append("rect")
		.attr("width", imW).attr("height", imH)
		.attr("transform", function(d,i){return "translate("+i%pgW*imW+","+Math.floor(i/pgW)*imH+")";})
		.attr("id", function(d){return "r"+d["pnum"];})
		.attr("class", function(d){
			retv = "imgbl";
			if (d["status"]=="ac") retv += " ac";
			if (d["status"]=="tried") retv += " tried";
			return retv;
		});
	
	var pane = d3.select("#contents").selectAll("div")
		.data(theData).enter()
		.append("div")
		.attr("id", function(d,i){return "tab"+i;})
		.attr("class", function(d,i){return "tab-pane fade"+((i==0)?" in active":"");});
	pane.append("div").attr("class", "table-wrap")
		.selectAll("div")
		.data(function(d){return d;})
		.enter()
		.append("div")
		.attr("class", function(d){
			retv = "inbl";
			if (d["status"]=="ac") retv += " ac";
			if (d["status"]=="tried") retv += " tried";
			return retv;
		})
		.attr("id", function(d){return "p"+d["pnum"];})
		.on("mouseover", mouseover).on("mouseleave", mouseleave)
		.html( function (d) { 
            retv = "<a href=\"https://uva.onlinejudge.org/index.php?option=com_onlinejudge&Itemid=8&page=show_problem&problem="+d["pid"]+"\">";
            retv += "<span class=\"pnum\">"+d["pnum"]+"</span>"+d["title"]+"</a>";
            if (d["time"]!="") {
                retv += "<p>";
                if (d["status"]=="ac") retv+="firstAC: ";
                else                   retv+="lastTry: ";
                dt = new Date(d["time"]*1000);
                yyyy = dt.getFullYear();
                mm = dt.getMonth()+1;
                dd = dt.getDate();
                retv += p0(yyyy)+"/"+p0(mm)+"/"+p0(dd);
                hh = dt.getHours();
                MM = dt.getMinutes();
                ss = dt.getSeconds();
                retv += " "+p0(hh)+":"+p0(MM);
                retv += "</p>";
            }
            return retv;
        } );
  
  injectEvent();
}

var pnum2tab={};
var theData;
function produceData(probs, subs) {
	//uname = subs["uname"];

	acs = [];
	subs["subs"].forEach(function(val,key,arr){
		pid = val[1];
		res = val[2];	// 10: sub err, 15: can't judge, 20: queue, 30: CE, 35: restrict func, 40: RE, 45: OLE, 50: TLE, 60: MLE, 70: WA, 80: PE, 90: AC
		time = val[4];
		if (res==90) {
			if (typeof acs[pid] != "undefined" && acs[pid]["ac"]) {
				if (time<acs[pid]["time"]) {
					acs[pid]["time"] = time;
				}
			}
			else {
				acs[pid] = {"ac":true, "time":time};
			}	
		}
		else {
			if (typeof acs[pid] == "undefined") {
				acs[pid] = {"ac":false, "time":time};
			}
			else if (acs[pid]["ac"]==false) {
				if (time>acs[pid]["time"]) {
					acs[pid]["time"] = time;
				}
			}
		}
	});

	keys = Object.keys(probs);
	keys.sort(function(a,b){return (probs[a][3]>probs[b][3])?-1:1;});

	theData = [];
	count = 0;
	keys.forEach(function(val,key,arr){
		prob = probs[val];
		if (typeof acs[prob[0]] != "undefined") {
			if (acs[prob[0]]["ac"]) {
				stat = "ac";
			}
			else {
				stat = "tried";
			}
			time = acs[prob[0]]["time"];
		}
		else {
			stat = "";
			time = "";
		}
		if (count%(pgW*pgH)==0) theData.push([]);
		theData[Math.floor(count/(pgW*pgH))].push({ "pid":prob[0], "pnum":prob[1], "title":prob[2], "DAcU":prob[3], "status":stat, "time":time });
		pnum2tab[prob[1]] = Math.floor(count/(pgW*pgH));
		count++;
	});

	render(theData);
}

var subs;
function getSubs(probs, uid) {
	d3.json("http://uhunt.felix-halim.net/api/subs-user/"+uid, function(err,json){
		if (err) {
			subs = [];
			console.warn(err);
		}
		else {
			subs = json;
		}

		produceData(probs, subs);
	});
}

var uid;
function getUid(probs, uname) {
	d3.json("http://uhunt.felix-halim.net/api/uname2uid/"+uname, function(err,json){
		if (err) {
			uid = [];
			console.warn(err);
		}
		else {
			uid = json;
		}

		getSubs(probs, uid);
	});
}

var probs;
function main(uname) {
  document.title = uname + " - " + document.title;
	d3.json("http://uhunt.felix-halim.net/api/p", function(err,json){
		if (err) return console.warn(error);
		probs = json;
		//probs = <?=json_encode($probs)?>;
		getUid(probs, uname);
	});
}

uname = window.location.hash.substring(1);
if (uname.length>0) main(uname);
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50207952-4', 'auto');
  ga('send', 'pageview', {
    'page': location.pathname + location.search  + location.hash
  });

</script>
</body>
</html>
